{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "clusterName": {
      "type": "string"
    },
    "clusterResourceGroup": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]"
    },
    "clusterLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "symphonyName": {
      "type": "string",
      "defaultValue": "symphony"
    },
    "installNamespace": {
      "type": "string",
      "defaultValue": "symphony"
    },
    "targetName": {
      "type": "string",
      "defaultValue": "self"
    },
    "customLocationName": {
      "type": "string",
      "defaultValue": "symphony-custom-location"
    },
    "update.gate.operationId": {
      "type": "string"
    },
    "update.gate.operationName": {
      "type": "string",
      "defaultValue": "Update"
    },
    "customLocationNamespace": {
      "type": "string"
    },
    "update.broker.address": {
      "type": "string"
    },
    "update.broker.clientID": {
      "type": "string",
      "defaultValue": "control-plane"
    },
    "version": {
      "type": "string",
      "defaultValue": "10.2307.0.1"
    }
  },
  "variables": {
    "customLocationName": "[parameters('customLocationName')]",
    "clusterId": "[resourceId('Microsoft.Kubernetes/connectedClusters', parameters('clusterName'))]",
    "syncRuleName": "[concat(parameters('symphonyName'), '-sync')]",
    "targetGateName": "[concat(parameters('targetName'), '-gate')]",
    "targetGateRequest": "[concat('{\"id\": \"', parameters('update.gate.operationId'), '\", \"operation\": \"', parameters('update.gate.operationName'), '\", \"target\": \"', parameters('targetName'), '\"}')]"
  },
  "resources": [
    {
      "type": "Microsoft.KubernetesConfiguration/extensions",
      "apiVersion": "2022-03-01",
      "name": "[parameters('symphonyName')]",
      "location": "[parameters('clusterLocation')]",
      "properties": {
        "extensionType": "private.symphony",
        "autoUpgradeMinorVersion": true,
        "scope": {
          "cluster": {
            "releaseNamespace": "[parameters('installNamespace')]"
          }
        },
        "version": "0.43.11",
        "releaseTrain": "dev",
        "configurationSettings": {
          "Microsoft.CustomLocation.ServiceAccount": "default"
        }
      },
      "scope": "[concat('Microsoft.Kubernetes/connectedClusters/', parameters('clusterName'))]"
    },
    {
      "type": "Microsoft.ExtendedLocation/customLocations",
      "apiVersion": "2021-08-31-preview",
      "name": "[variables('customLocationName')]",
      "location": "[parameters('clusterLocation')]",
      "properties": {
        "hostResourceId": "[variables('clusterId')]",
        "namespace": "[parameters('customLocationNamespace')]",
        "displayName": "[variables('customLocationName')]",
        "clusterExtensionIds": [
          "[concat(variables('clusterId'), '/providers/Microsoft.KubernetesConfiguration/extensions/', parameters('symphonyName'))]"
        ]
      },
      "dependsOn": [
        "[parameters('symphonyName')]"
      ]
    },
    {
      "type": "private.symphony/targets",
      "name": "[parameters('targetName')]",
      "location": "[parameters('clusterLocation')]",
      "apiVersion": "2020-01-01-preview",
      "extendedLocation": {
        "name": "[resourceId('Microsoft.ExtendedLocation/customLocations', variables('customLocationName'))]",
        "type": "CustomLocation"
      },
      "properties": {
        "components": [
          {
            "name": "[variables('targetGateName')]",
            "type": "gate",
            "properties": {
              "http.url": "https://ak-approvalgate.azure-api.net/approval",
              "http.method": "POST",
              "http.body": "[variables('targetGateRequest')]"
            }
          },
          {
            "name": "[parameters('targetName')]",
            "type": "update",
            "properties": {
              "app.package": "update",
              "version": "[parameters('version')]"
            },
            "dependencies": [
              "[variables('targetGateName')]"
            ]
          }
        ],
        "topologies": [
          {
            "bindings": [
              {
                "role": "gate",
                "provider": "providers.target.http"
              },
              {
                "role": "update",
                "provider": "providers.target.mqtt",
                "config": {
                  "brokerAddress": "[parameters('update.broker.address')]",
                  "clientID": "[parameters('update.broker.clientID')]",
                  "requestTopic": "symphony-request",
                  "responseTopic": "symphony-response",
                  "timeoutSeconds": "300"
                }
              }
            ]
          }
        ]
      },
      "dependsOn": [
        "[variables('customLocationName')]"
      ]
    },
    {
      "type": "Microsoft.ExtendedLocation/customLocations/resourceSyncRules",
      "apiVersion": "2021-08-31-preview",
      "name": "[concat(variables('customLocationName'), '/', variables('syncRuleName'))]",
      "location": "[parameters('clusterLocation')]",
      "properties": {
        "priority": 100,
        "selector": {
          "matchLabels": {
            "management.azure.com/provider-name": "private.symphony"
          }
        },
        "targetResourceGroup": "[resourceGroup().id]"
      },
      "dependsOn": [
        "[variables('customLocationName')]"
      ]
    }
  ],
  "outputs": {
    "operation": {
      "type": "string",
      "value": "[variables('targetGateRequest')]"
    }
  }
}